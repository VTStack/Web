"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.moveDirectory = exports.migrateStorybookInstance = exports.migrateAllStorybookInstances = exports.migrateDefaultsGenerator = void 0;
const devkit_1 = require("@nrwl/devkit");
const semver_1 = require("semver");
const versions_1 = require("../../../utils/versions");
const path_1 = require("path");
const version_utils_1 = require("@nrwl/workspace/src/utilities/version-utils");
const typescript_1 = require("@nrwl/workspace/src/utilities/typescript");
function migrateDefaultsGenerator(tree) {
    migrateAllStorybookInstances(tree);
    migrateRootLevelStorybookInstance(tree);
    return upgradeStorybookPackagesInPackageJson(tree);
}
exports.migrateDefaultsGenerator = migrateDefaultsGenerator;
function migrateAllStorybookInstances(tree) {
    devkit_1.logger.debug('adding .storybook folder to project');
    const projects = (0, devkit_1.getProjects)(tree);
    const projectsThatHaveStorybookConfiguration = [...projects.entries()]
        .filter(([_, projectConfig]) => projectConfig.targets &&
        projectConfig.targets.storybook &&
        projectConfig.targets.storybook.executor !==
            '@nrwl/react-native:storybook')
        .map(([projectName, projectConfig]) => {
        if (projectConfig.targets && projectConfig.targets.storybook) {
            return {
                name: projectName,
                uiFramework: projectConfig.targets.storybook.options.uiFramework,
                configFolder: projectConfig.targets.storybook.options.config.configFolder,
            };
        }
    });
    for (const projectWithStorybook of projectsThatHaveStorybookConfiguration) {
        migrateStorybookInstance(tree, projectWithStorybook.name, projectWithStorybook.uiFramework, projectWithStorybook.configFolder);
    }
}
exports.migrateAllStorybookInstances = migrateAllStorybookInstances;
function migrateStorybookInstance(tree, projectName, uiFramework, configFolder) {
    migrateProjectLevelStorybookInstance(tree, projectName, uiFramework, configFolder);
}
exports.migrateStorybookInstance = migrateStorybookInstance;
function maybeUpdateVersion(tree) {
    let needsInstall = false;
    (0, devkit_1.updateJson)(tree, 'package.json', (json) => {
        json.dependencies = json.dependencies || {};
        json.devDependencies = json.devDependencies || {};
        const allStorybookPackagesInDependencies = Object.keys(json.dependencies).filter((packageName) => packageName.startsWith('@storybook/') &&
            !packageName.includes('@storybook/react-native') &&
            !packageName.includes('@storybook/storybook-deployer'));
        const allStorybookPackagesInDevDependencies = Object.keys(json.devDependencies).filter((packageName) => packageName.startsWith('@storybook/') &&
            !packageName.includes('@storybook/react-native') &&
            !packageName.includes('@storybook/storybook-deployer'));
        const storybookPackages = [
            ...allStorybookPackagesInDependencies,
            ...allStorybookPackagesInDevDependencies,
        ];
        storybookPackages.forEach((storybookPackageName) => {
            if (json.dependencies[storybookPackageName]) {
                const version = (0, version_utils_1.checkAndCleanWithSemver)(storybookPackageName, json.dependencies[storybookPackageName]);
                if ((0, semver_1.lte)(version, '6.0.0')) {
                    json.dependencies[storybookPackageName] = versions_1.storybookVersion;
                    needsInstall = true;
                }
            }
            if (json.devDependencies[storybookPackageName]) {
                const version = (0, version_utils_1.checkAndCleanWithSemver)(storybookPackageName, json.devDependencies[storybookPackageName]);
                if ((0, semver_1.lte)(version, '6.0.0')) {
                    json.devDependencies[storybookPackageName] = versions_1.storybookVersion;
                    needsInstall = true;
                }
            }
        });
        return json;
    });
    if (needsInstall) {
        return () => (0, devkit_1.installPackagesTask)(tree);
    }
}
function upgradeStorybookPackagesInPackageJson(tree) {
    /**
     * Should upgrade all @storybook/* packages in package.json
     */
    return maybeUpdateVersion(tree);
}
function moveOldFiles(tree, configFolderDir) {
    moveDirectory(tree, configFolderDir, configFolderDir.replace('.storybook', '.old_storybook'));
}
function migrateProjectLevelStorybookInstance(tree, projectName, uiFramework, configFolder) {
    const { root, projectType } = (0, devkit_1.readProjectConfiguration)(tree, projectName);
    const projectDirectory = projectType === 'application' ? 'app' : 'lib';
    const old_folder_exists_already = tree.exists(configFolder.replace('.storybook', '.old_storybook'));
    const new_config_exists_already = tree.exists(`${configFolder}/main.js`);
    if (old_folder_exists_already || new_config_exists_already) {
        return;
    }
    moveOldFiles(tree, configFolder);
    if (tree.exists(configFolder)) {
        return;
    }
    (0, devkit_1.generateFiles)(tree, (0, path_1.join)(__dirname, '../../../generators/configuration/project-files/.storybook'), configFolder, {
        tmpl: '',
        uiFramework,
        offsetFromRoot: (0, devkit_1.offsetFromRoot)(root),
        rootTsConfigPath: (0, typescript_1.getRootTsConfigPathInTree)(tree),
        projectType: projectDirectory,
        useWebpack5: uiFramework === '@storybook/angular',
        existsRootWebpackConfig: tree.exists('.storybook/webpack.config.js'),
    });
}
function migrateRootLevelStorybookInstance(tree) {
    const old_folder_exists_already = tree.exists('.old_storybook');
    const new_config_exists_already = tree.exists(`.storybook/main.js`);
    if (old_folder_exists_already || new_config_exists_already) {
        return;
    }
    moveOldFiles(tree, '.storybook');
    (0, devkit_1.generateFiles)(tree, (0, path_1.join)(__dirname, '../../../generators/configuration/root-files/.storybook'), '.storybook', { rootTsConfigPath: (0, typescript_1.getRootTsConfigPathInTree)(tree) });
}
function moveDirectory(tree, from, to) {
    (0, devkit_1.visitNotIgnoredFiles)(tree, from, (file) => {
        tree.rename(file, file.replace(from, to));
    });
}
exports.moveDirectory = moveDirectory;
//# sourceMappingURL=migrate-defaults-5-to-6.js.map